format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: other
workflows:
  build_rbenv_ruby_3:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -euxo pipefail

            VERSION=3.2.2
            brew uninstall --ignore-dependencies readline gmp readline
            
            rm -rf ~/.rbenv/versions/$VERSION
            
            rbenv install $VERSION --verbose
            zip -r $BITRISE_DEPLOY_DIR/$VERSION.zip ~/.rbenv/versions/$VERSION
    - deploy-to-bitrise-io@2: {}
    meta:
      bitrise.io:
        stack: osx-xcode-14.2.x-ventura-rosetta
        machine_type_id: g2-m1-max.10core
  make_ruby:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            make

            VERSION=3.2.2
            zip $VERSION.zip ~/.rbenv/versions/$VERSION
            mv $VERSION.zip $BITRISE_DEPLOY_DIR
    - deploy-to-bitrise-io@2: {}
  primary:
    after_run:
    - gem_install_bundler
    - run_bundler
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
  gem_install_bundler:
    before_run:
    - verify_environment
    steps:
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -eo pipefail
            gem install bundler --force --no-document
  run_bundler:
    before_run:
    - verify_environment
    steps:
    - bundler@0: {}
  verify_environment:
    steps:
    - script@1:
        inputs:
        - content: "#!/usr/bin/env bash\nset -eo pipefail\n\necho \"Architecture is $(uname -m)\"\necho \"Ruby version is $(ruby --version)\"\necho \"Path is ${PATH}\"\nif [[ $(ruby --version) != *$(<.ruby-version)* ]]; then\n  echo \"Unexpected ruby version\"\n\texit 1\nfi"
meta:
  bitrise.io:
    stack: osx-xcode-14.3.x-ventura
    machine_type_id: g2-m1-max.10core
